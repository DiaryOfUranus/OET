
<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>文明秩序演进理论</title>
    <link rel="stylesheet" href="../css/style.css">
</head>
<body>
    <header class="header">
        <div class="container">
            <div class="logo"><a href="../index.html">秩序演进理论体系</a></div>
            <nav class="nav">
                <a href="../index.html" class="nav-link">首页</a>
                <a href="#" class="nav-link active">文明秩序演进理论</a>
            </nav>
        </div>
    </header>

    <main class="main">
        <div class="container">
            <div class="theory-layout">
                <aside class="sidebar">
                    <div class="chapter-nav">
                        <h3 class="chapter-nav__title">
                            文明秩序演进理论
                            <select id="version-select" style="margin-left: 10px; padding: 4px;"></select>
                        </h3>
                        <ul class="chapter-nav__list" id="chapter-list"></ul>
                    </div>
                </aside>
                <article class="content" id="content-container"><p style='color:#666;'>正在加载内容...</p></article>
            </div>
        </div>
    </main>

    <footer class="footer">
        <div class="container">
            <p>秩序演进理论体系 © 2025</p>
        </div>
    </footer>

    <script src="../js/markdown-it.min.js"></script>
    <script src="../js/common.js"></script>
    <script>
        // 核心配置：MD文件路径统一指向 theories/markdown 文件夹
        const relationalOrderConfig = {
            title: "文明秩序演进理论",
            baseMdPath: "markdown/civilizationOrder", // 相对于theories目录（当前HTML所在目录）
            versions: {
                "1.0": {
                    chapters: [
                        { id: "Preface", title: "序言", mdPath: "1.0/Preface.md" }, // 完整路径：theories/markdown/civilizationOrder/1.0/Preface.md
                        { id: "CivilizationOntology", title: "第一部分：文明本体论", mdPath: "1.0/CivilizationOntology.md" }
                    ]
                }
            }
        };

        // 全局存储已加载的MD内容，避免重复请求
        let cachedMdContent = {};
        // 页面DOM加载完成后初始化（比window.onload更早，避免DOM获取延迟）
        document.addEventListener("DOMContentLoaded", async function() {
            try {
                // 校验核心DOM元素是否存在
                const requiredElements = ["version-select", "chapter-list", "content-container"];
                requiredElements.forEach(id => {
                    if (!document.getElementById(id)) throw new Error(`核心DOM元素缺失：#${id}`);
                });
                // 初始化版本选择器和章节导航
                initNav(relationalOrderConfig);
                // 加载默认章节（第一个版本的第一章）
                await loadDefaultChapter(relationalOrderConfig);
            } catch (err) {
                console.error("页面初始化失败：", err);
                document.getElementById("content-container").innerHTML = `<p style='color:red;'>初始化失败：${err.message}</p>`;
            }
        });

        // 初始化版本和章节导航
        function initNav(config) {
            const versionSelect = document.getElementById("version-select");
            const chapterList = document.getElementById("chapter-list");
            const versions = Object.keys(config.versions);

            // 填充版本选择器
            versions.forEach(version => {
                const option = document.createElement("option");
                option.value = version;
                option.textContent = `版本 ${version}`;
                versionSelect.appendChild(option);
            });

            // 版本切换事件：更新章节并加载默认章节
            versionSelect.addEventListener("change", async function() {
                const selectedVersion = this.value;
                const chapters = config.versions[selectedVersion].chapters;
                renderChapterList(chapters, config.baseMdPath);
                await loadMdContent(config.baseMdPath + "/" + chapters[0].mdPath);
            });

            // 初始化默认章节列表
            renderChapterList(config.versions[versions[0]].chapters, config.baseMdPath);
        };

        // 渲染章节列表，绑定路径点击事件
        function renderChapterList(chapters, basePath) {
            const chapterList = document.getElementById("chapter-list");
            chapterList.innerHTML = ""; // 清空原有章节
            chapters.forEach(chapter => {
                const fullMdPath = basePath + "/" + chapter.mdPath;
                const li = document.createElement("li");
                li.innerHTML = `<a href="#" data-path="${fullMdPath}" class="chapter-link">${chapter.title}</a>`;
                // 章节点击加载对应MD内容（添加防抖，避免重复点击）
                const link = li.querySelector("a");
                link.addEventListener("click", async (e) => {
                    e.preventDefault();
                    if (link.classList.contains("loading")) return; // 禁止重复加载
                    link.classList.add("loading");
                    await loadMdContent(e.target.getAttribute("data-path"));
                    link.classList.remove("loading");
                });
                chapterList.appendChild(li);
            });
        };

        // 加载默认章节
        async function loadDefaultChapter(config) {
            const defaultVersion = Object.keys(config.versions)[0];
            const defaultChapter = config.versions[defaultVersion].chapters[0];
            const fullMdPath = config.baseMdPath + "/" + defaultChapter.mdPath;
            await loadMdContent(fullMdPath);
        };

        // 加载MD内容并渲染到页面（核心优化：细分错误类型、补充路径日志）
        async function loadMdContent(fullPath) {
            const contentContainer = document.getElementById("content-container");
            try {
                contentContainer.innerHTML = `<p style='color:#666;'>加载中：${fullPath}...</p>'`;
                console.log("请求MD文件路径：", fullPath); // 日志打印实际请求路径，方便排查

                // 优先使用缓存内容
                if (cachedMdContent[fullPath]) {
                    console.log("使用缓存内容加载");
                    renderMd(cachedMdContent[fullPath]);
                    return;
                }

                // 发起请求加载MD文件（处理本地文件跨域问题提示）
                const response = await fetch(fullPath);
                // 细分HTTP错误状态
                if (!response.ok) {
                    let errMsg = `HTTP错误 ${response.status} `;
                    switch(response.status) {
                        case 404: errMsg += `（文件未找到，请检查路径：${fullPath}）`; break;
                        case 403: errMsg += "（无访问权限，请检查文件权限）"; break;
                        case 500: errMsg += "（服务器内部错误）"; break;
                        default: errMsg += `（请求失败）`;
                    }
                    throw new Error(errMsg);
                }

                const mdText = await response.text();
                if (!mdText.trim()) throw new Error("MD文件内容为空");
                cachedMdContent[fullPath] = mdText; // 缓存内容
                renderMd(mdText);
            } catch (err) {
                console.error("MD文件加载失败：", err);
                // 本地文件访问提示（浏览器直接打开HTML会限制file协议请求）
                const localTip = window.location.protocol === "file:" ? "<br/>提示：本地打开需通过HTTP服务器（如VSCode Live Server）运行，避免跨域限制" : "";
                contentContainer.innerHTML = `<p style='color:red;'>加载失败：${err.message}${localTip}</p>`;
            }
        };

        // 渲染MD内容（依赖markdown-it插件，增加插件存在校验）
        function renderMd(mdText) {
            if (!window.markdownit) {
                document.getElementById("content-container").innerHTML = `<p style='color:red;'>markdown-it插件未加载，无法渲染内容</p>`;
                return;
            }
            const md = window.markdownit({ html: true, breaks: true, linkify: true });
            const html = md.render(mdText);
            document.getElementById("content-container").innerHTML = html;
        };
    </script>
</body>
</html>